# Engram V2 Production Fixes

**Date:** 2026-02-23
**Status:** Implemented
**Plan:** docs/plans/2026-02-23-engram-v2-production-fixes.md
**R&D:** docs/rnd/2026-02-23-engram-v2-fixes.md

## Overview

Comprehensive production hardening of the Engram V2 memory system: a new UDS communication layer between hooks and the daemon, a shared project resolver, tighter dedup thresholds, adaptive extraction, Laplace-smoothed scoring, MEMORY.md size caps with archival, and two new MCP tools (`memory_forget`, `memory_status`). Roughly 80+ individual fixes spanning all runtime components.

## What Changed (by category)

### Infrastructure

**UDS (Unix Domain Socket) Communication** -- `shared/uds.ts`
- New `createEngramServer()` starts a UDS listener on `~/.claude-memory/engram.sock` in the daemon. Accepts one JSON message per connection, dispatches to a handler callback. Includes a 10-second idle timeout per connection and a 64KB data limit to prevent memory exhaustion from rogue connections.
- New `sendEngramMessage()` client function used by hooks. Connects, writes one JSON message, disconnects. 2-second connect timeout. Returns `true`/`false` (never throws). Handles `ECONNREFUSED`/`ENOENT` silently when daemon is not running.
- Fallback `close` event handler covers daemon crashes where neither `end` nor `error` fire.
- The daemon (`processor/index.ts`) creates the UDS server at startup and closes it + unlinks the socket file during shutdown.

**Project Resolver** -- `shared/project-resolver.ts`
- New shared module for consistent project name resolution across daemon and MCP server.
- `resolveProjectFromJsonlPath()` reads the first line of a JSONL transcript, extracts the `cwd` field, derives project name from `path.basename(cwd)`. Result cached per JSONL path in a `Map`.
- `resolveProjectFromCwd()` walks up from a directory looking for `.claude/` to find the project boundary. Used by the MCP server's `detectProject()`.
- `isProjectRoot()` checks `CLAUDE_MEMORY_PROJECT_ROOTS` env var to detect root project directories (which get `scope: global` treatment for extracted memories).
- `clearProjectCache()` exposed for testing.
- Daemon's `startTailer()` now calls `resolveProjectFromJsonlPath()` and passes `ProjectInfo` to `SessionTailer`, which uses it for accurate `projectName` and `projectIsRoot` assignment.

**Tailer Eviction and Cleanup** -- `processor/index.ts`
- Stale tailer eviction runs every 60 seconds: checks each tailer's JSONL file `mtime` against a 7-day cutoff. Missing files also trigger eviction.
- Eviction stops are bounded by a 10-second `Promise.race` timeout to prevent hung tailers from blocking the scan loop.
- Eviction collects paths to evict in a separate array, then stops outside the iteration loop to avoid modifying the `Map` during iteration.
- Recollection file cleanup on eviction: `~/.claude-memory/recollections/<sessionId>.json` is unlinked when a tailer is evicted.
- `stateStore.pruneStale()` called on every scan cycle to remove state entries for sessions older than the max age.

**Daemon Shutdown** -- `processor/index.ts`
- `shutdown()` awaits all tailer `.stop()` calls with individual 10-second `Promise.race` timeouts.
- UDS server is closed and socket file unlinked during shutdown.
- `chokidarWatcher.close()` is awaited during shutdown.
- `stateStore.stop()` saves final state.
- `db.close()` wrapped in try/catch for already-closed case.
- PID file removed last.

### Extraction Pipeline

**Adaptive Extraction Threshold** -- `processor/session-tailer.ts`
- First extraction triggers after 5 messages (`INITIAL_MESSAGE_THRESHOLD`) instead of 15, so new sessions get memories faster.
- Subsequent extractions use the standard 15-message threshold (`STANDARD_MESSAGE_THRESHOLD`).
- Tracked via `hasExtractedOnce` boolean flag, reset on first successful extraction.

**Async Stop with Buffer Flush** -- `processor/session-tailer.ts`
- `stop()` is now `async`: flushes remaining extraction buffer with a 10-second `Promise.race` timeout before saving final byte offset.
- `stoppedDuringProcessing` flag ensures byte offset is saved correctly even if `stop()` is called mid-read.
- Public `flush()` method allows the UDS handler to trigger extraction of buffered messages (used by the stop hook's flush signal).

**Extraction Retry with Exponential Backoff** -- `processor/session-tailer.ts`
- On extraction failure, buffer is preserved (not cleared) and an exponential backoff is applied: 15s, 30s, 60s, 120s max.
- During backoff, the extraction buffer is capped at 100 messages (half is trimmed if exceeded) to prevent unbounded growth.
- Backoff resets to 0 on the next successful extraction.
- Non-interruptible guard (`extracting` flag) prevents concurrent extraction calls.

**Dedup Threshold Raised to 0.92** -- `processor/extractor.ts`
- Episode cosine similarity dedup threshold raised from 0.85 to 0.92. The previous 0.85 was too aggressive and merged semantically distinct episodes.

**Append-on-Update Instead of Replace** -- `processor/extractor.ts`
- When a candidate matches an existing episode (similarity > 0.92), the summary and `full_content` are appended with a `|` separator (summary) or `\n---\n` separator (full_content) instead of replacing.
- If the merged summary exceeds 500 characters, only the newer summary is kept.
- If the merged `full_content` exceeds 4000 characters, only the newer content is kept.
- `access_count` is incremented on update.

**Cross-Project Scope Rules** -- `processor/extractor.ts`
- Extraction prompt includes `PROJECT_IS_ROOT` flag and detailed scope rules.
- Memories about different projects or general user preferences are scoped as `global`.
- Memories about the current project are scoped as `project`.
- Root project directories (detected via `CLAUDE_MEMORY_PROJECT_ROOTS`) default to `global` scope.
- Null-project safety: if `projectName` is null but candidate scope is `project`, it is coerced to `global` to prevent unreachable episodes.

### MCP Server

**`memory_forget` Tool** -- `mcp/server.ts`
- New tool to delete a specific episode by ID. Validates ID format (must start with `ep_`).
- Checks existence before deletion. Returns the deleted episode's summary for confirmation.
- Relies on the `episodes_ad` trigger in `schema.ts` to automatically clean up the FTS5 index.

**`memory_status` Tool** -- `mcp/server.ts`
- New tool to check Engram system health. Reports:
  - Daemon status (running/not running, PID, uptime from PID file mtime).
  - UDS socket existence.
  - Schema version.
  - Episode counts total, by project, and by importance.
  - Chunk count (indexed markdown segments).
  - Active recollection file count.
  - DB path.

**Scoring Fixes in `memory_recall`** -- `mcp/server.ts`
- BM25 normalization: when all BM25 hits have the same score (single-hit case), normalized score is set to 0.5 instead of 1.0 to prevent a single keyword match from dominating.
- Laplace-smoothed access frequency: `(access_count + 1) / (maxAccess + 1)` so new episodes with 0 access are not penalized to exactly 0.
- High-importance floor: episodes with `importance = 'high'` get a minimum effective relevance of 0.3, preventing them from being buried when keyword overlap is low.
- `access_count` is only incremented in `memory_expand`, not in `memory_recall` (prevents inflation from passive recall).

**Project Normalization** -- `mcp/server.ts`
- `detectProject()` now delegates to `shared/project-resolver.ts` via `resolveProjectFromCwd()` instead of inline logic.
- Accepts optional `cwd` parameter in `memory_save` for project detection when the MCP server CWD differs from the session CWD.

### Recollection System

**LIMIT 200 on Episode Fetch** -- `processor/recollection-writer.ts`
- The episode vector scan query now uses `LIMIT 200` instead of unbounded, reducing memory and CPU cost for large episode tables.
- Episodes are sorted by `accessed_at DESC` to prioritize recently relevant ones.

**Laplace-Smoothed Access Frequency** -- `processor/recollection-writer.ts`
- Same `(access_count + 1) / (maxAccess + 1)` formula as the MCP server, ensuring new episodes are not penalized to zero in scoring.

**BM25 Single-Hit Fix** -- `processor/recollection-writer.ts`
- When BM25 min equals max (single hit), normalized score is 0.5 instead of a division-by-zero edge case or full 1.0.

**High-Importance Relevance Floor** -- `processor/recollection-writer.ts`
- Episodes with `importance = 'high'` receive a minimum relevance score of 0.3, same as the MCP server.

**Staleness Check** -- `hooks/pretooluse-recollection.ts`
- Before injecting memory bites, checks the recollection file's timestamp. If older than 5 minutes (`MAX_STALE_MS`), checks whether the daemon PID is alive.
- If daemon is dead and recollection is stale, skips injection entirely (data is unreliable).
- If daemon is alive but recollection is stale, still injects (daemon may be processing a batch).

**Eager Refresh** -- `processor/recollection-writer.ts`
- New `refreshRecollection()` function re-runs the recollection pipeline with the session's last user message after an extraction cycle. Called by the daemon so that newly extracted episodes are immediately available for recollection.

**UDS Flush from Stop Hook** -- `hooks/stop.ts`
- On session end, the stop hook sends a `{ event: 'flush', sessionId }` message to the daemon via UDS.
- The daemon receives this and calls `tailer.flush()` to extract any remaining buffered messages before the session's JSONL file goes stale.
- Fire-and-forget: if the daemon is not running, the send silently returns `false`.

### Consolidation

**MEMORY.md Size Cap** -- `processor/consolidator.ts`
- `MAX_MEMORY_LINES = 200`: if MEMORY.md exceeds 200 lines after graduation, the oldest sections (split on `## ` headers) are archived.
- Preamble (non-header content before the first `## `) is preserved.
- Archived sections are appended to `~/.claude-memory/archive/YYYY-MM.md` (monthly archive files).

**Time-Based Graduation** -- `processor/consolidator.ts`
- High-importance episodes older than 14 days graduate regardless of access count. Prevents cold-start knowledge loss for important but infrequently accessed memories.
- Time-based candidates are limited to `global` scope and capped at `MAX_GRADUATED_PER_CYCLE`.
- Deduplicated against access-based candidates by episode ID.

**Dedup on Formatted Entry** -- `processor/consolidator.ts`
- Graduation dedup checks the full formatted entry (including date and project tag), not just the raw summary, preventing false dedup on identical summaries from different projects or dates.

### Schema

**Migration Locking** -- `mcp/schema.ts`
- All migrations (v2, v3, v4) use `BEGIN EXCLUSIVE` transactions to prevent concurrent migration races between the MCP server and daemon.
- `SQLITE_BUSY` / `database is locked` errors trigger a 6-second retry with a version re-check (another process may have completed the migration).
- v4 migration (`graduated_at` column) handles the `duplicate column` edge case from partial prior migrations by bumping the version atomically without re-adding the column.

## Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `shared/uds.ts` | created | UDS server/client for hook-to-daemon communication (flush signals) |
| `shared/project-resolver.ts` | created | Shared project resolution from JSONL paths and CWD |
| `processor/index.ts` | modified | UDS server startup/shutdown, project resolver integration, tailer eviction with recollection cleanup, async tailer stops with timeouts |
| `processor/session-tailer.ts` | modified | Adaptive threshold (5/15), async stop with flush, exponential backoff retry, public flush() for UDS, extraction buffer cap |
| `processor/extractor.ts` | modified | 0.92 dedup threshold, append-on-update merging, cross-project scope rules, null-project coercion |
| `processor/consolidator.ts` | modified | 200-line MEMORY.md cap with monthly archival, time-based graduation (14 days), formatted-entry dedup |
| `processor/recollection-writer.ts` | modified | LIMIT 200 on episode fetch, Laplace scoring, BM25 single-hit fix, high-importance floor, eager refresh function |
| `mcp/server.ts` | modified | memory_forget and memory_status tools, Laplace scoring in recall, BM25 single-hit normalization, project resolver delegation |
| `mcp/schema.ts` | modified | BEGIN EXCLUSIVE migration locking, SQLITE_BUSY retry with version re-check, v4 duplicate-column handling |
| `hooks/stop.ts` | modified | UDS flush signal to daemon on session end |
| `hooks/pretooluse-recollection.ts` | modified | 5-minute staleness check with daemon liveness verification |

## Architecture Decisions

**UDS over HTTP for hook-daemon communication.** Unix domain sockets are lower latency than HTTP, have no port conflicts, and are naturally scoped to the local machine. The socket file at `~/.claude-memory/engram.sock` also serves as a presence indicator. Chose fire-and-forget semantics (no response required) since the flush signal is best-effort.

**0.92 dedup threshold (up from 0.85).** The original 0.85 threshold was merging episodes that were semantically related but distinct (e.g., "decided to use UDS" and "implemented UDS server"). 0.92 ensures only near-identical episodes merge while still catching reformulations of the same fact.

**Append-on-update instead of replace.** When episodes merge, appending context preserves the history of how understanding evolved. The size caps (500 chars summary, 4000 chars full_content) prevent unbounded growth while keeping the most recent information when truncation is needed.

**Laplace smoothing for access frequency.** Raw `access_count / maxAccess` penalizes new episodes to exactly 0, making them invisible in scoring. Adding 1 to both numerator and denominator (Laplace smoothing) gives new episodes a reasonable baseline score without distorting the ranking of frequently accessed episodes.

**5-minute staleness threshold for recollection injection.** Balances freshness against false negatives. If the daemon is alive, stale data may just mean a long extraction is running. If the daemon is dead, stale recollections reflect an outdated state and should not be injected.

**200-line MEMORY.md cap with monthly archives.** Prevents MEMORY.md from growing indefinitely (which would bloat session-start context injection). Oldest sections are preserved in monthly archive files for retrieval via memory_search.

**Time-based graduation at 14 days.** High-importance episodes that are never recalled still contain valuable knowledge. Graduating them after 14 days regardless of access count prevents cold-start knowledge loss for users who do not actively use `memory_expand`.

**Project resolver reads first JSONL line.** The first line of a session JSONL always contains the `cwd` field, which is the most reliable source for project identity. Caching per JSONL path means this is a one-time cost per session.

## Known Limitations

- **No response on UDS flush.** The flush signal is fire-and-forget; the stop hook cannot confirm extraction completed before exit.
- **Monthly archive files are write-only.** Archived MEMORY.md sections are searchable via `memory_search` (if indexed) but not automatically loaded into session-start context.
- **Topic-change gating uses a fixed cosine threshold** (configurable via `ENGRAM_TOPIC_THRESHOLD` but not adaptive per user).
- **Project name collisions** are possible if different projects share the same `path.basename()`.
- **No log rotation** for daemon stdout/stderr.
- **macOS only** -- LaunchAgent and UDS paths are macOS-specific.
- **Extraction quality depends on transcript content** -- very short sessions or heavily tool-output-dominated transcripts may not yield useful episodes.
- **JSONL first-line CWD assumption** -- if the first line lacks a `cwd` field (e.g., from a non-standard client), project resolution falls back to null.

## Testing Notes

### Manual Verification Checklist

1. **Daemon startup**: `bun processor/index.ts` -- verify PID file created, UDS socket created at `~/.claude-memory/engram.sock`, no startup errors.
2. **Session discovery**: Start a Claude Code session -- verify tailer picks it up within 60 seconds (check daemon stderr).
3. **Adaptive extraction**: Chat for 5 messages -- verify first extraction triggers (check `bun scripts/inspect.ts`). Then chat for 15 more -- verify second extraction.
4. **Flush on stop**: End the Claude Code session -- verify `[stop-hook] Sent flush signal to daemon` in hook output and `[uds] Flush requested for session ...` in daemon stderr.
5. **Staleness check**: Kill the daemon, wait 6 minutes, then trigger a tool call -- verify no stale recollection bites are injected.
6. **memory_forget**: Use `memory_recall` to find an episode, then `memory_forget` with its ID -- verify deletion message and that `memory_recall` no longer returns it.
7. **memory_status**: Call `memory_status` tool -- verify daemon status, episode counts, schema version, socket existence are all reported.
8. **MEMORY.md cap**: Manually add content to MEMORY.md exceeding 200 lines, trigger consolidation -- verify archival to `~/.claude-memory/archive/YYYY-MM.md` and MEMORY.md is trimmed.
9. **Eviction cleanup**: Create a session JSONL file with mtime > 7 days old, wait for scan cycle -- verify tailer eviction and recollection file deletion.
10. **Migration locking**: Start MCP server and daemon simultaneously against a fresh DB -- verify no `SQLITE_BUSY` crashes and schema reaches v4.

### Inspect CLI
```bash
bun scripts/inspect.ts          # human-readable health report
bun scripts/inspect.ts --json   # machine-readable JSON output
```

### Configuration Reference

| Setting | Default | Env Var / Location |
|---------|---------|-------------------|
| Dedup threshold (episodes) | 0.92 | `processor/extractor.ts` |
| Initial extraction trigger | 5 messages | `processor/session-tailer.ts` |
| Standard extraction trigger | 15 messages | `processor/session-tailer.ts` |
| Time-based extraction trigger | 20 minutes | `processor/session-tailer.ts` |
| Extraction backoff | 15s-120s exponential | `processor/session-tailer.ts` |
| Extraction buffer cap | 100 messages | `processor/session-tailer.ts` |
| Topic change threshold | 0.85 | `ENGRAM_TOPIC_THRESHOLD` |
| Recollection LIMIT | 200 episodes | `processor/recollection-writer.ts` |
| Recollection staleness | 5 minutes | `hooks/pretooluse-recollection.ts` |
| MEMORY.md cap | 200 lines | `processor/consolidator.ts` |
| Time-based graduation | 14 days | `processor/consolidator.ts` |
| Graduation min access count | 3 | `processor/consolidator.ts` |
| Compression age | 30 days | `processor/consolidator.ts` |
| Max graduated per cycle | 10 | `processor/consolidator.ts` |
| Cold consolidation interval | 4 hours | `processor/index.ts` |
| Session scan interval | 60 seconds | `processor/index.ts` |
| Max file age (tailer eviction) | 7 days | `processor/index.ts` |
| Memory restart threshold | 512 MB RSS | `processor/index.ts` |
| UDS connect timeout | 2 seconds | `shared/uds.ts` |
| UDS connection idle timeout | 10 seconds | `shared/uds.ts` |
| UDS data limit | 64 KB | `shared/uds.ts` |
